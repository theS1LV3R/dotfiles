#!/usr/bin/env bash

# shellcheck source=/dev/null
source "$HOME/.local/bin/__common.sh"

cachedir="$HOME/.cache/cheat.sh/"
url="https://cheat.sh/$*"

mkdir -p "$cachedir"

ping -c 1 -w 1 cheat.sh >/dev/null 2>&1
exitstatus=$?

if [[ $exitstatus -ne 0 ]]; then
    log_warn "Unable to connect to cheat.sh, please check your internet connection."

    if [ -f "$cachedir/$*" ]; then
        log_info "Using cached version. Last updated: $(stat -c %y "$cachedir/$*")"
        pager "$cachedir/$*"
        exit 0
    else
        log_error "Page requested not in cache."
        exit 1
    fi
fi

log_info "Opening $url"
page=$(curl -s "$url")

if ! echo "$page" | grep -ivq "Unknown topic."; then
    pager "$page"
    exit 1
fi

echo "$page" >"$cachedir/$*"

pager "$page"
